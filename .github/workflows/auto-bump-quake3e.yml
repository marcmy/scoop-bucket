name: Auto-bump quake3e
on:
  schedule:
    - cron: '7 */6 * * *'   # every 6 hours at :07 UTC
  workflow_dispatch: {}

permissions:
  contents: write

concurrency:
  group: auto-bump-quake3e
  cancel-in-progress: true

jobs:
  bump:
    runs-on: windows-latest
    steps:
      - name: Checkout bucket
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Scoop (idempotent)
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (-not (Get-Command scoop -ErrorAction SilentlyContinue)) {
            iwr get.scoop.sh -useb | iex
            Write-Host "Scoop installed"
          } else {
            Write-Host "Scoop already installed"
          }

          $buckets = & scoop bucket list 2>&1 | Out-String
          if ($buckets -notmatch '\bmain\b') {
            Write-Host "Adding main bucket"
            & scoop bucket add main
          } else {
            Write-Host "main bucket already present; skipping add"
          }

      - name: Prepare bucket dir for checkver
        shell: pwsh
        run: |
          # ensure scoop shims are available in this step's PATH
          $env:PATH = "$env:USERPROFILE\scoop\shims;$env:PATH"

          $ScoopRoot = "$env:USERPROFILE\scoop"
          if (Test-Path "$ScoopRoot\buckets\marcmy") { Remove-Item -Recurse -Force "$ScoopRoot\buckets\marcmy" }
          New-Item -ItemType Directory -Force -Path "$ScoopRoot\buckets\marcmy\bucket" | Out-Null
          Copy-Item -Recurse -Force "$env:GITHUB_WORKSPACE\bucket\*" "$ScoopRoot\buckets\marcmy\bucket\"

      - name: checkver -u (stamp version/URLs/hashes)
        shell: pwsh
        run: |
          # ensure scoop shims are available in this step's PATH
          $env:PATH = "$env:USERPROFILE\scoop\shims;$env:PATH"

          $ScoopRoot = "$env:USERPROFILE\scoop"
          Set-Location "$ScoopRoot\buckets\marcmy"
          & "$ScoopRoot\buckets\main\bin\checkver.ps1" quake3e -u -Force -Verbose
          Copy-Item "$ScoopRoot\buckets\marcmy\bucket\quake3e.json" "$env:GITHUB_WORKSPACE\bucket\quake3e.json" -Force

      - name: Commit if changed
        shell: pwsh
        run: |
          git config user.name  "auto-bump"
          git config user.email "autobump@users.noreply.github.com"
          git add bucket/quake3e.json
          if (git diff --cached --quiet) { echo "No changes"; exit 0 }
          git commit -m "auto-bump: quake3e"
          git push
